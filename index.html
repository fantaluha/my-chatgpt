<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatGPT Chat</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: #0d0d0d;
    color: #e0e0e0;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: #1a1a1a;
    border-bottom: 1px solid #2a2a2a;
    flex-shrink: 0;
  }

  .header h1 {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
  }

  .header-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* Settings panel */
  .settings-toggle {
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    color: #ccc;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: background 0.15s;
  }

  .settings-toggle:hover { background: #3a3a3a; }

  .settings-panel {
    background: #1a1a1a;
    border-bottom: 1px solid #2a2a2a;
    padding: 16px 20px;
    display: none;
    flex-shrink: 0;
  }

  .settings-panel.open { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; }

  .setting-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .setting-group label {
    font-size: 11px;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .setting-group input, .setting-group select {
    background: #0d0d0d;
    border: 1px solid #3a3a3a;
    color: #e0e0e0;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
  }

  .setting-group input:focus, .setting-group select:focus {
    outline: none;
    border-color: #10a37f;
  }

  .api-key-input { width: 320px; font-family: monospace; }
  .api-key-wrapper { position: relative; display: flex; align-items: center; }
  .api-key-wrapper input { padding-right: 36px; width: 100%; }
  .eye-btn {
    position: absolute;
    right: 8px;
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 14px;
    padding: 2px;
  }

  /* Status indicator */
  .status {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #555;
  }

  .status.connected .status-dot { background: #10a37f; }
  .status.disconnected .status-dot { background: #ef4444; }

  /* Chat area */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .chat-area::-webkit-scrollbar { width: 6px; }
  .chat-area::-webkit-scrollbar-track { background: transparent; }
  .chat-area::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

  .message {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.6;
    word-wrap: break-word;
    white-space: pre-wrap;
    position: relative;
  }

  .message.user {
    align-self: flex-end;
    background: #10a37f;
    color: #fff;
    border-bottom-right-radius: 4px;
  }

  .message.assistant {
    align-self: flex-start;
    background: #1e1e1e;
    color: #e0e0e0;
    border-bottom-left-radius: 4px;
    border: 1px solid #2a2a2a;
  }

  .message.system-msg {
    align-self: center;
    background: transparent;
    color: #666;
    font-size: 12px;
    padding: 8px;
    max-width: 100%;
    text-align: center;
  }

  .message.error {
    align-self: center;
    background: #2d1b1b;
    color: #ef4444;
    border: 1px solid #3d2020;
    font-size: 13px;
    max-width: 90%;
  }

  /* Typing indicator */
  .typing-indicator {
    align-self: flex-start;
    padding: 16px;
    display: none;
  }

  .typing-indicator.visible { display: flex; gap: 4px; }

  .typing-dot {
    width: 8px;
    height: 8px;
    background: #555;
    border-radius: 50%;
    animation: typing 1.2s infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
    30% { opacity: 1; transform: translateY(-4px); }
  }

  /* Input area */
  .input-area {
    padding: 16px 20px;
    background: #1a1a1a;
    border-top: 1px solid #2a2a2a;
    flex-shrink: 0;
  }

  .input-wrapper {
    display: flex;
    gap: 10px;
    max-width: 900px;
    margin: 0 auto;
  }

  .input-wrapper textarea {
    flex: 1;
    background: #0d0d0d;
    border: 1px solid #3a3a3a;
    color: #e0e0e0;
    padding: 12px 14px;
    border-radius: 10px;
    font-size: 14px;
    font-family: inherit;
    resize: none;
    min-height: 44px;
    max-height: 150px;
    line-height: 1.4;
    transition: border-color 0.15s;
  }

  .input-wrapper textarea:focus {
    outline: none;
    border-color: #10a37f;
  }

  .send-btn {
    background: #10a37f;
    border: none;
    color: #fff;
    width: 44px;
    height: 44px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
    flex-shrink: 0;
    align-self: flex-end;
  }

  .send-btn:hover { background: #0d8c6d; }
  .send-btn:disabled { background: #333; cursor: not-allowed; }

  .clear-btn {
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    color: #999;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.15s;
  }

  .clear-btn:hover { background: #3a3a3a; color: #ccc; }

  /* Welcome screen */
  .welcome {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    gap: 12px;
    color: #555;
  }

  .welcome h2 {
    font-size: 24px;
    color: #888;
    font-weight: 500;
  }

  .welcome p {
    font-size: 14px;
    max-width: 400px;
    text-align: center;
    line-height: 1.6;
  }

  /* Code blocks in messages */
  .message code {
    background: #0d0d0d;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 13px;
  }

  .message pre {
    background: #0d0d0d;
    padding: 12px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 8px 0;
  }

  .message pre code {
    background: none;
    padding: 0;
  }

  /* Token counter */
  .token-info {
    font-size: 11px;
    color: #555;
    text-align: center;
    padding: 4px;
  }
</style>
</head>
<body>

<div class="header">
  <h1>ChatGPT Chat</h1>
  <div class="header-controls">
    <div class="status disconnected" id="status">
      <span class="status-dot"></span>
      <span id="statusText">No API Key</span>
    </div>
    <button class="clear-btn" onclick="clearChat()">Nuova chat</button>
    <button class="settings-toggle" onclick="toggleSettings()">Impostazioni</button>
  </div>
</div>

<div class="settings-panel" id="settingsPanel">
  <div class="setting-group">
    <label>API Key</label>
    <div class="api-key-wrapper api-key-input">
      <input type="password" id="apiKey" placeholder="sk-..." oninput="onApiKeyChange()">
      <button class="eye-btn" onclick="toggleKeyVisibility()" id="eyeBtn">üëÅ</button>
    </div>
  </div>
  <div class="setting-group">
    <label>Modello</label>
    <select id="model" onchange="updateState()">
      <option value="gpt-4.1">GPT-4.1</option>
      <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
      <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
      <option value="gpt-4.5-preview">GPT-4.5 Preview</option>
      <option value="gpt-5-nano">GPT-5 Nano</option>
      <option value="gpt-4o">GPT-4o</option>
      <option value="gpt-4o-mini">GPT-4o Mini</option>
      <option value="o3">o3</option>
      <option value="o3-mini">o3-mini</option>
      <option value="o1">o1</option>
      <option value="o1-mini">o1-mini</option>
      <option value="gpt-4-turbo">GPT-4 Turbo</option>
      <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
    </select>
  </div>
  <div class="setting-group">
    <label>System Prompt</label>
    <input type="text" id="systemPrompt" placeholder="Sei un assistente utile..." style="width:300px" oninput="updateState()">
  </div>
</div>

<div class="chat-area" id="chatArea">
  <div class="welcome" id="welcome">
    <h2>Benvenuto</h2>
    <p>Configura la tua API key di OpenAI nelle impostazioni e inizia a chattare.</p>
  </div>
</div>

<div class="typing-indicator" id="typingIndicator">
  <div class="typing-dot"></div>
  <div class="typing-dot"></div>
  <div class="typing-dot"></div>
</div>

<div class="token-info" id="tokenInfo"></div>

<div class="input-area">
  <div class="input-wrapper">
    <textarea id="userInput" placeholder="Scrivi un messaggio..." rows="1"
      onkeydown="handleKeydown(event)" oninput="autoResize(this)"></textarea>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚Üë</button>
  </div>
</div>

<script>
  const state = {
    apiKey: '',
    model: 'gpt-4o',
    systemPrompt: '',
    messages: [],
    isLoading: false
  };

  // Elements
  const chatArea = document.getElementById('chatArea');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const typingIndicator = document.getElementById('typingIndicator');
  const welcome = document.getElementById('welcome');
  const statusEl = document.getElementById('status');
  const statusText = document.getElementById('statusText');
  const tokenInfo = document.getElementById('tokenInfo');

  function updateState() {
    state.model = document.getElementById('model').value;
    localStorage.setItem('openai_model', state.model);
    state.systemPrompt = document.getElementById('systemPrompt').value;
    if (state.systemPrompt) {
      localStorage.setItem('openai_system_prompt', state.systemPrompt);
    } else {
      localStorage.removeItem('openai_system_prompt');
    }
  }

  function onApiKeyChange() {
    state.apiKey = document.getElementById('apiKey').value.trim();
    if (state.apiKey && state.apiKey.startsWith('sk-')) {
      localStorage.setItem('openai_api_key', state.apiKey);
      statusEl.className = 'status connected';
      statusText.textContent = 'Pronto';
    } else if (state.apiKey) {
      statusEl.className = 'status disconnected';
      statusText.textContent = 'Key non valida';
    } else {
      localStorage.removeItem('openai_api_key');
      statusEl.className = 'status disconnected';
      statusText.textContent = 'No API Key';
    }
  }

  // Load saved settings on startup
  (function loadSaved() {
    const savedKey = localStorage.getItem('openai_api_key');
    if (savedKey) {
      document.getElementById('apiKey').value = savedKey;
      onApiKeyChange();
    }
    const savedPrompt = localStorage.getItem('openai_system_prompt');
    if (savedPrompt) {
      document.getElementById('systemPrompt').value = savedPrompt;
      state.systemPrompt = savedPrompt;
    }
    const savedModel = localStorage.getItem('openai_model');
    if (savedModel) {
      document.getElementById('model').value = savedModel;
      state.model = savedModel;
    }
  })();

  function toggleSettings() {
    document.getElementById('settingsPanel').classList.toggle('open');
  }

  function toggleKeyVisibility() {
    const input = document.getElementById('apiKey');
    input.type = input.type === 'password' ? 'text' : 'password';
  }

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 150) + 'px';
  }

  function handleKeydown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  function addMessage(role, content) {
    if (welcome) welcome.style.display = 'none';

    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.textContent = content;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function addError(text) {
    const div = document.createElement('div');
    div.className = 'message error';
    div.textContent = text;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function clearChat() {
    state.messages = [];
    chatArea.innerHTML = '';
    const w = document.createElement('div');
    w.className = 'welcome';
    w.id = 'welcome';
    w.innerHTML = '<h2>Nuova Chat</h2><p>Inizia a scrivere un messaggio.</p>';
    chatArea.appendChild(w);
    tokenInfo.textContent = '';
  }

  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text || state.isLoading) return;

    if (!state.apiKey) {
      addError('Inserisci la tua API key nelle impostazioni.');
      return;
    }

    // Add user message
    state.messages.push({ role: 'user', content: text });
    addMessage('user', text);
    userInput.value = '';
    userInput.style.height = 'auto';

    // Show typing
    state.isLoading = true;
    sendBtn.disabled = true;
    typingIndicator.classList.add('visible');

    try {
      const apiMessages = [];

      if (state.systemPrompt) {
        apiMessages.push({ role: 'system', content: state.systemPrompt });
      }

      apiMessages.push(...state.messages);

      const body = {
        model: state.model,
        messages: apiMessages
      };

      // o1/o3 models don't support system prompts
      if (state.model.startsWith('o1') || state.model.startsWith('o3')) {
        if (state.systemPrompt) {
          body.messages = body.messages.map(m =>
            m.role === 'system' ? { ...m, role: 'user' } : m
          );
        }
      }

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${state.apiKey}`
        },
        body: JSON.stringify(body)
      });

      const data = await response.json();

      if (!response.ok) {
        const errMsg = data.error?.message || `Errore HTTP ${response.status}`;
        throw new Error(errMsg);
      }

      const reply = data.choices[0].message.content;
      state.messages.push({ role: 'assistant', content: reply });
      addMessage('assistant', reply);

      // Token info
      if (data.usage) {
        tokenInfo.textContent = `Token usati: ${data.usage.prompt_tokens} prompt + ${data.usage.completion_tokens} completamento = ${data.usage.total_tokens} totali`;
      }

    } catch (err) {
      addError(`Errore: ${err.message}`);
    } finally {
      state.isLoading = false;
      sendBtn.disabled = false;
      typingIndicator.classList.remove('visible');
    }
  }

  // Open settings on load
  document.getElementById('settingsPanel').classList.add('open');
  userInput.focus();
</script>

</body>
</html>